numNodes = 36;
c0 = sym('c0', [numNodes, 1]);
c = sym('c', [numNodes, 1]);

% 手动从表格导入以下变量

%seg_node_table = [1,1,2;2,2,5;3,2,3;4,3,4;5,4,5;6,5,6;7,6,7;8,7,8;9,7,9;10,8,10;11,9,11;12,11,12;13,12,13;14,13,14;15,14,15;16,13,16;17,15,17;18,16,17;19,17,18;20,18,32;21,16,19;22,14,20;23,20,21;24,21,22;25,20,22;26,24,23;27,15,24;28,23,25;29,25,26;30,25,31;31,31,27;32,27,29;34,29,28;35,22,33;36,33,34;37,32,19;38,29,35;39,35,30;40,28,35;41,28,36];
%k = [1.64000000000000;1.68000000000000;2.18000000000000;2.18000000000000;1.70000000000000;1.70000000000000;0.720000000000000;1.30000000000000;0.710000000000000;1.30000000000000;0.710000000000000;0.980000000000000;0.980000000000000;0.980000000000000;0.980000000000000;4.30000000000000;3.20000000000000;3.20000000000000;1.28000000000000;1.28000000000000;4.30000000000000;1.53000000000000;1.56000000000000;1.56000000000000;1.56000000000000;0.980000000000000;0.980000000000000;0.980000000000000;0.980000000000000;1.19000000000000;1.19000000000000;1.19000000000000;1.19000000000000;1.56000000000000;1.56000000000000;1.73000000000000;1.73000000000000;1.73000000000000;1.73000000000000;1.73000000000000];
%t = [0.0926000000000000;0.0421000000000000;0.125400000000000;0.277800000000000;1.15740000000000;0.0661000000000000;0.156300000000000;0.463000000000000;0.0289000000000000;0.578700000000000;0.0623000000000000;0.439800000000000;0.347200000000000;0.0661000000000000;0.0193000000000000;0.0868000000000000;0.0827000000000000;0.138900000000000;0.115700000000000;0.135000000000000;0.324100000000000;0.115700000000000;0.214900000000000;1.50460000000000;0.214900000000000;0.0224000000000000;0.0103000000000000;0.0105000000000000;0.00550000000000000;0.0868000000000000;0.0514000000000000;0.0926000000000000;0.810200000000000;1.15740000000000;0.463000000000000;0.289400000000000;0.578700000000000;1.15740000000000;2.70010000000000;0.868100000000000];
%Q = [104.160000000000;78.9100000000000;19.0100000000000;8.09000000000000;1.85000000000000;74.5200000000000;70.6200000000000;10.9200000000000;56.5800000000000;3.90000000000000;45.6600000000000;18.5300000000000;6.05000000000000;-26.1400000000000;-65.1400000000000;30.6300000000000;33.3300000000000;7.42000000000000;25.1400000000000;9.54000000000000;7.62000000000000;37.4400000000000;11.3500000000000;-1.13000000000000;11.2700000000000;-108.610000000000;-100.030000000000;-114.850000000000;-147.610000000000;28.0800000000000;14.8200000000000;8.58000000000000;1.34000000000000;2.34000000000000;1.17000000000000;-3.72000000000000;1.78000000000000;2.34000000000000;0.560000000000000;0.780000000000000];

for i = 1:size(seg_node_table, 1)
    if Q(i) < 0
        tmp = seg_node_table(i, 3);
        seg_node_table(i, 3) = seg_node_table(i, 2);
        seg_node_table(i, 2) = tmp;
    end
end
Q = abs(Q);

iterations = 0;
while 1
    iterations = iterations + 1
    hasAllExpanded = 1;
    for i = 1:numNodes
        idx_i = find(seg_node_table(:, 3) == i);  % indexes of seg_node_table in which downstream node is i
        if has(c(i), ['c' num2str(i)])
            if isempty(idx_i)
                c(i) = c0(i);
            else
                c(i) = sym(0);
                sum_Q = sym(0);
                for m = 1:length(idx_i)
                    j = seg_node_table(idx_i(m), 2);
                    sum_Q = sum_Q + Q(idx_i(m));
                    c(i) = c(i) + c(j)*exp(-k(idx_i(m))*t(idx_i(m)))*Q(idx_i(m));
                    if has(c(i), ['c' num2str(j)])
                        hasAllExpanded = 0;
                    end
                end
                c(i) = c(i) / sum_Q;
                c(i) = c(i) + c0(i);
            end
        else
            for j = 1:numNodes
                if has(c(i), ['c' num2str(j)])
                    hasAllExpanded = 0;
                    c(i) = subs(c(i), ['c' num2str(j)], c(j));
                end
            end
        end
    end
    if hasAllExpanded == 1
        break;
    end
end

optim_vars = [1 26 7 22 35];  % 手动填入节点

N_vars = length(optim_vars);
A = zeros(numNodes, N_vars);
for j = 1:numNodes
    for i = 1:N_vars
        x = zeros(numNodes, 1);
        x(optim_vars(i)) = 1;
        A(j, i) = subs(c(j), c0, x);
    end
end
% save A to A.csv
csvwrite('../A.csv', A);

for i = 1:numNodes
    vpa(c(i), 5)
end
